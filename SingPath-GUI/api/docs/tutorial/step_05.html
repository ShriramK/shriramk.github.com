<h1>Tutorial: 5 - XHRs &amp; Dependency Injection</h1>
<div class="tutorial-5-xhrs-dependency-injection"><ul doc:tutorial-nav="5"></ul>

<p>Enough of building an app with three phones in a hard-coded dataset! Let's fetch a larger dataset
from our server using one of angular's built-in <a href="#!/api/angular.service"><code>services</code></a> called <a href="#!/api/angular.service.$xhr"><code>$xhr</code></a>. We will use angular's <a href="#!/guide/dev_guide.di">dependency injection (DI)</a> to provide the service to the <code>PhoneListCtrl</code> controller.</p><doc:tutorial-instructions step="5"></doc:tutorial-instructions><p>You should now see a list of 20 phones.</p>

<p>The most important changes are listed below. You can see the full diff on <a href="https://github.com/angular/angular-phonecat/compare/step-4...step-5">GitHub</a>:</p>

<h3>Data</h3>

<p>The <code>app/phones/phone.json</code> file in your project is a dataset that contains a larger list of phones
stored in the JSON format.</p>

<p>Following is a sample of the file:</p><div ng:non-bindable><pre class="brush: js;">
[
 {
  "age": 13,
  "id": "motorola-defy-with-motoblur",
  "name": "Motorola DEFY\u2122 with MOTOBLUR\u2122",
  "snippet": "Are you ready for everything life throws your way?"
  ...
 },
...
]
</pre></div><h3>Controller</h3>

<p>We'll use angular's <a href="#!/api/angular.service.$xhr"><code>$xhr</code></a> service in our controller to make an HTTP
request to your web server to fetch the data in the <code>app/phones/phones.json</code> file. <code>$xhr</code> is just
one of several built-in <a href="#!/api/angular.service"><code>angular services</code></a> that handle common operations
in web apps. Angular injects these services for you where you need them.</p>

<p>Services are managed by angular's <a href="#!/guide/dev_guide.di">DI subsystem</a>. Dependency injection
helps to make your web apps both well-structured (e.g., separate components for presentation, data,
and control) and loosely coupled (dependencies between components are not resolved by the
components themselves, but by the DI subsystem).</p>

<p><strong><code>app/js/controllers.js:</code></strong></p><div ng:non-bindable><pre class="brush: js;">
function PhoneListCtrl($xhr) {
  var self = this;

  $xhr('GET', 'phones/phones.json', function(code, response) {
    self.phones = response;
  });

  self.orderProp = 'age';
}

//PhoneListCtrl.$inject = ['$xhr'];
</pre></div><p><code>$xhr</code> makes an HTTP GET request to our web server, asking for <code>phone/phones.json</code> (the url is
relative to our <code>index.html</code> file). The server responds by providing the data in the json file.
(The response might just as well have been dynamically generated by a backend server. To the
browser and our app they both look the same. For the sake of simplicity we used a json file in this
tutorial.)</p>

<p>The <code>$xhr</code> service takes a callback as the last argument. This callback is used to process the
response. We assign the response to the scope controlled by the controller, as a model called
<code>phones</code>. Notice that angular detected the json response and parsed it for us!</p>

<p>To use a service in angular, you simply declare the names of the services you need as arguments to
the controller's constructor function, as follows:</p>

<pre><code>function PhoneListCtrl($xhr) {...}
</code></pre>

<p>Angular's dependency injector provides services to your controller when the controller is being
constructed. The dependency injector also takes care of creating any transitive dependencies the
service may have (services often depend upon other services).</p>

<p><img src="img/tutorial/xhr_service_final.png"></p>

<h4>'$' Prefix Naming Convention</h4>

<p>You can create your own services, and in fact we will do exactly that in step 11. As a naming
convention, angular's built-in services, Scope methods and a few other angular APIs have a '$'
prefix in front of the name.  Don't use a '$' prefix when naming your services and models, in order
to avoid any possible naming collisions.</p>

<h4>A Note on Minification</h4>

<p>Since angular infers the controller's dependencies from the names of arguments to the controller's
constructor function, if you were to <a href="http://en.wikipedia.org/wiki/Minification_(programming)">minify</a> the JavaScript code for <code>PhoneListCtrl</code> controller, all of its function arguments would be
minified as well, and the dependency injector would not being able to identify services correctly.</p>

<p>To overcome issues caused by minification, just assign an array with service identifier strings
into the <code>$inject</code> property of the controller function, just like the last line in the snippet
(commented out) suggests:</p>

<pre><code>PhoneListCtrl.$inject = ['$xhr'];
</code></pre>

<h3>Test</h3>

<p><strong><code>test/unit/controllersSpec.js</code>:</strong></p>

<p>Because we started using dependency injection and our controller has dependencies, constructing the
controller in our tests is a bit more complicated. We could use the <code>new</code> operator and provide the
constructor with some kind of fake <code>$xhr</code> implementation. However, the recommended (and easier) way
is to create a controller in the test environment in the same way that angular does it in the
production code behind the scenes, as follows:</p><div ng:non-bindable><pre class="brush: js;">
describe('PhoneCat controllers', function() {

  describe('PhoneListCtrl', function() {
    var scope, $browser, ctrl;

    beforeEach(function() {
      scope = angular.scope();
      $browser = scope.$service('$browser');

      $browser.xhr.expectGET('phones/phones.json')
          .respond([{name: 'Nexus S'},
                    {name: 'Motorola DROID'}]);
      ctrl = scope.$new(PhoneListCtrl);
    });
  });
</pre></div><p>We created the controller in the test environment, as follows:</p>

<ul>
<li><p>We created a root scope object by calling <code>angular.scope()</code></p></li>
<li><p>We called <code>scope.$new(PhoneListCtrl)</code> to get angular to create the child scope associated with
the <code>PhoneListCtrl</code> controller</p></li>
</ul>

<p>Because our code now uses the <code>$xhr</code> service to fetch the phone list data in our controller, before
we create the <code>PhoneListCtrl</code> child scope, we need to tell the testing harness to expect an
incoming request from the controller. To do this we:</p>

<ul>
<li><p>Use the <a href="#!/api/angular.scope.$service"><code><code>$service</code></code></a> method to retrieve the <code>$browser</code> service,
a service that angular uses to represent various browser APIs. In tests, angular automatically uses
a mock version of this service that allows you to write tests without having to deal with these
native APIs and the global state associated with them.</p></li>
<li><p>Use the <code>$browser.xhr.expectGET</code> method to train the <code>$browser</code> object to expect an incoming HTTP
request and tell it what to respond with. Note that the responses are not returned before we call
the <code>$browser.xhr.flush</code> method.</p></li>
</ul>

<p>Now, we will make assertions to verify that the <code>phones</code> model doesn't exist on the scope, before
the response is received:</p><div ng:non-bindable><pre class="brush: js;">
    it('should create "phones" model with 2 phones fetched from xhr', function() {
      expect(ctrl.phones).toBeUndefined();
      $browser.xhr.flush();

      expect(ctrl.phones).toEqual([{name: 'Nexus S'},
                                   {name: 'Motorola DROID'}]);
    });
</pre></div><ul>
<li><p>We flush the xhr queue in the browser by calling <code>$browser.xhr.flush()</code>. This causes the callback
we passed into the <code>$xhr</code> service to be executed with the trained response.</p></li>
<li><p>We make the assertions, verifying that the phone model now exists on the scope.</p></li>
</ul>

<p>Finally, we verify that the default value of <code>orderProp</code> is set correctly:</p><div ng:non-bindable><pre class="brush: js;">
    it('should set the default value of orderProp model', function() {
      expect(ctrl.orderProp).toBe('age');
    });
  });
});
</pre></div><p>To run the unit tests, execute the <code>./scripts/test.sh</code> script and you should see the following
output.</p>

<pre><code>   Chrome: Runner reset.
   ..
   Total 2 tests (Passed: 2; Fails: 0; Errors: 0) (3.00 ms)
     Chrome 11.0.696.57 Mac OS: Run 2 tests (Passed: 2; Fails: 0; Errors 0) (3.00 ms)
</code></pre>

<h2>Experiments</h2>

<ul>
<li><p>At the bottom of <code>index.html</code>, add a <code>{{phones}}</code> binding to see the list of phones displayed in
json format.</p></li>
<li><p>In the <code>PhoneListCtrl</code> controller, pre-process the xhr response by limiting the number of phones
to the first 5 in the list. Use the following code in the xhr callback:</p>

<pre><code> self.phones = response.splice(0, 5);
</code></pre></li>
</ul>

<h2>Summary</h2>

<p>Now that you have learned how easy it is to use angular services (thanks to angular's
implementation of dependency injection), go to <a href="#!/tutorial/step_06">step 6</a>, where you will add some
thumbnail images of phones and some links.</p>

<ul doc:tutorial-nav="5"></ul></div>
